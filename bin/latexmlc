#!/usr/bin/perl -w

#######################
# A Client for LaTeXML
#######################

use strict;
use FindBin;
use lib "$FindBin::RealBin/../lib";
use Pod::Usage;
use Carp;
use IO::Socket;

my @opts = grep ($_ =~ /^-/,@ARGV);
my @args = grep ($_ !~ /^-/,@ARGV);

my ($port) = map {$_=~/(\d+)/; $1;} grep {$_ =~ /^--port=(\d+)$/;} @opts;
$port = 3334 unless $port; #Default is 3334

my $sock = new IO::Socket::INET
  ( PeerAddr => '127.0.0.1',
    PeerPort => $port,
    Proto => 'tcp',
  ); #Attempt connecting to a service
unless ($sock) {
  #Startup daemon with @opts and feed in args
  push(@opts,'--local'); #bootstrap local switch.
  system('latexmls',@opts);
}

#Daemon is running, feed in @args and @opts
$sock = new IO::Socket::INET 
  ( PeerAddr => '127.0.0.1',
    PeerPort => $port,
    Proto => 'tcp',
  );
croak "Could not create socket: $!\n" unless $sock; 
foreach my $arg(@args) {
  my $text;
  $sock->send(join(" ",@opts)."\n".$arg."\nEND REQUEST\n");
  $sock->recv($text,1024);
  print $text;
}
close($sock);

#**********************************************************************
__END__

=head1 NAME

C<latexmlc> - A client for latexml, latexmlpost and latexmlmath.

=head1 SYNOPSIS

See latexmls for allowed options.

=head1 DESCRIPTION

latexmlc provides a client which automatically sets up a LaTeXML local server if necessary
(via latexmls).

If such server already exists, the client proceeds to communicate normally.

=head1 SEE ALSO

L<latexmlc>, L<latexmld>, L<latexml>, L<latexmlpost>, L<latexmlmath>, L<LaTeXML>

=cut
#**********************************************************************

